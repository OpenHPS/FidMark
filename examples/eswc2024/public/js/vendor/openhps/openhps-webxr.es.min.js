import*as e from"./openhps-core.es.min.js";var t={d:(e,i)=>{for(var r in i)t.o(i,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},i={};t.d(i,{pX:()=>WebXRService,Zw:()=>d,oG:()=>XRSink,vU:()=>XRSource});const r=(e=>{var i={};return t.d(i,e),i})({Absolute3DPosition:()=>e.Absolute3DPosition,DataFrame:()=>e.DataFrame,DataObject:()=>e.DataObject,LengthUnit:()=>e.LengthUnit,Matrix3:()=>e.Matrix3,SerializableArrayMember:()=>e.SerializableArrayMember,SerializableMember:()=>e.SerializableMember,SerializableObject:()=>e.SerializableObject,Service:()=>e.Service,SinkNode:()=>e.SinkNode,SourceNode:()=>e.SourceNode});function s(e,t,i,r){var s,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(a=(o<3?s(a):o>3?s(t,i,a):s(t,i))||a);return o>3&&a&&Object.defineProperty(t,i,a),a}function o(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}Object.create;Object.create;let a=class CameraObject extends r.DataObject{get focalLength(){if(this.cameraMatrix)return[this.cameraMatrix.elements[0],this.cameraMatrix.elements[4]]}get principalPoint(){if(this.cameraMatrix)return[this.cameraMatrix.elements[6],this.cameraMatrix.elements[7]]}get aspect(){return this.width/this.height}get rows(){return this.height}set rows(e){this.height=e}get cols(){return this.width}set cols(e){this.width=e}constructor(e,t,i,r){var s;super(e,t),this.colorOrder=n.RGB,this.width=i||0,this.height=r||0,this.distortionCoefficients=null!==(s=this.distortionCoefficients)&&void 0!==s?s:[0,0,0,0,0]}};var n;s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"width",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"height",void 0),s([(0,r.SerializableArrayMember)(Number),o("design:type",Array)],a.prototype,"distortionCoefficients",void 0),s([(0,r.SerializableMember)(),o("design:type",r.Matrix3)],a.prototype,"cameraMatrix",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"fps",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],a.prototype,"colorOrder",void 0),a=s([(0,r.SerializableObject)(),o("design:paramtypes",[String,String,Number,Number])],a),function(e){e[e.RGB=0]="RGB",e[e.BGR=1]="BGR",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.RGBA=3]="RGBA",e[e.BGRA=4]="BGRA"}(n||(n={}));let c=class ImageFrame extends r.DataFrame{get rows(){return this.height}set rows(e){this.height=e}get cols(){return this.width}set cols(e){this.width=e}get source(){return super.source}set source(e){super.source=e}};s([(0,r.SerializableMember)(),o("design:type",Object)],c.prototype,"image",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],c.prototype,"height",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],c.prototype,"width",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],c.prototype,"fourcc",void 0),s([(0,r.SerializableMember)(),o("design:type",Number)],c.prototype,"fps",void 0),c=s([(0,r.SerializableObject)()],c);let h=class DepthImageFrame extends c{};s([(0,r.SerializableMember)(),o("design:type",Object)],h.prototype,"depth",void 0),s([(0,r.SerializableMember)(),o("design:type",r.LengthUnit)],h.prototype,"depthUnit",void 0),h=s([(0,r.SerializableObject)()],h);let l=class DepthVideoFrame extends h{};l=s([(0,r.SerializableObject)()],l);let d=class XRDataFrame extends l{};s([(0,r.SerializableMember)(),o("design:type",Float32Array)],d.prototype,"viewerPose",void 0),s([(0,r.SerializableMember)(),o("design:type",Float32Array)],d.prototype,"targetPose",void 0),d=s([(0,r.SerializableObject)()],d);class XRSource extends r.SourceNode{constructor(e){super(e),this._refSpace=null,this._service=null,this.options.source=this.options.source||new a(this.uid),this.options.output=void 0===this.options.output||this.options.output,this.on("build",this._onBuild.bind(this)),this.once("destroy",this._onDestroy.bind(this))}get source(){return super.source}_onBuild(){return new Promise(((e,t)=>(this._service=this.model.findService("WebXRService"),void 0===this._service||null===this._service?t(new Error("WebXR service was not added to model!")):this.options.autoStart?this.start().then(e).catch(t):void e())))}start(){return new Promise(((e,t)=>{this._service.session.requestReferenceSpace("local").then((t=>{this.logger("debug","Local reference space created. Starting animation frames ..."),this._refSpace=t,this._service.session.requestAnimationFrame(this._onXRFrame.bind(this)),e()})).catch(t)}))}_onDestroy(){return new Promise((e=>{this._service.session.end(),e()}))}_onXRFrame(e,t){const i=t.getViewerPose(this._refSpace),s=this._service.gl;if(i){const o=new d;o.source=this.source.clone(),o.source.colorOrder=n.RGBA;for(const e of i.views){const i=this._service.session.renderState.baseLayer.getViewport(e);s.viewport(i.x,i.y,i.width,i.height);const r=t.getDepthInformation(e),a=this._service.glBinding.getCameraImage(e.camera);if(o.depth=r,o.texture=a,o.height=e.camera.height,o.width=e.camera.width,o.source.width=e.camera.width,o.source.height=e.camera.height,this.options.includeImage){const e=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,e),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,o.texture,0);const t=new Uint8Array(o.width*o.height*4);s.readPixels(0,0,o.width,o.height,s.RGBA,s.UNSIGNED_BYTE,t),o.image=t}break}this.options.output&&this._service.gl.bindFramebuffer(this._service.gl.FRAMEBUFFER,t.session.renderState.baseLayer.framebuffer);const a=i.transform.matrix,c=i.transform.position,h=new r.Absolute3DPosition(c.x,c.y,c.z);i.emulatedPosition&&h.setAccuracy(100,r.LengthUnit.CENTIMETER),this.source.position=h,o.createdTimestamp=e,o.viewerPose=a,o.rawFrame=t,o.source=this.source,o.refSpace=this._refSpace,this.push(o).then((()=>{t.session.requestAnimationFrame(this._onXRFrame.bind(this))}))}else t.session.requestAnimationFrame(this._onXRFrame.bind(this))}onPull(){return new Promise((e=>{null!==this._service.session&&this._service.session.requestAnimationFrame(this._onXRFrame.bind(this)),e(void 0)}))}}class WebXRService extends r.Service{constructor(e){if(super(),this._session=null,this.options=e||{},this.options.autoStart=void 0!==this.options.autoStart&&this.options.autoStart,this.options.requiredFeatures=this.options.requiredFeatures||["local","hit-test","camera-access","depth-sensing","dom-overlay"],!this.options.gl){let e=document.createElement("canvas");this.options.canvas?e="string"==typeof this.options.canvas?document.getElementById(this.options.canvas):this.options.canvas:document.body.appendChild(e),this.options.gl=e.getContext("webgl",{xrCompatible:!0})}this.options.autoStart&&this.once("build",this._onBuild.bind(this))}_onBuild(){return new Promise(((e,t)=>{this.createSession().then((()=>{e()})).catch(t)}))}createSession(){return new Promise(((e,t)=>{if(!navigator.xr)return t(new Error("WebXR is not supported!"));navigator.xr.requestSession("immersive-ar",{requiredFeatures:this.options.requiredFeatures,depthSensing:{usagePreference:["cpu-optimized","gpu-optimized"],dataFormatPreference:["luminance-alpha","float32"]},domOverlay:{root:document.body}}).then((t=>{this._session=t,this.glBinding=new XRWebGLBinding(t,this.gl),this._session.updateRenderState({baseLayer:new XRWebGLLayer(this._session,this.gl)}),e(t)})).catch(t)}))}get session(){return this._session}get gl(){return this.options.gl}}class XRSink extends r.SinkNode{constructor(e){super(e),this._service=null,this.once("build",this._onBuild.bind(this)),this.once("destroy",this._onDestroy.bind(this))}_onBuild(){return new Promise(((e,t)=>{if(this._service=this.model.findService(WebXRService),void 0===this._service||null===this._service)return t(new Error("WebXR service was not added to model!"));e()}))}_onDestroy(){return new Promise((e=>{e()}))}onPush(){return new Promise((e=>{const t=this._service.gl,i=this._service.session;t.bindFramebuffer(t.FRAMEBUFFER,i.renderState.baseLayer.framebuffer),e()}))}}var u=i.pX,p=i.Zw,m=i.oG,b=i.vU;export{u as WebXRService,p as XRDataFrame,m as XRSink,b as XRSource};
//# sourceMappingURL=openhps-webxr.es.min.js.map